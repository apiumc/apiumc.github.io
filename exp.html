<!doctype html>
<html>

<head>
    <title>顾家数据平台</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <script type="text/javascript">
        // if (!navigator.userAgent.match(/(iPhone|iPod|Android|ios)/i)) {

        //     location.href = '/sso.html';
        // }
    </script>
    <link href="/rs/css/weui.css" rel="stylesheet" type="text/css" />
    <link href="/rs/css/base.css" rel="stylesheet" type="text/css" />
    <link href="/rs/css/icon.css" rel="stylesheet" type="text/css" />
    <link href="/rs/css/umc.ui.css?v.012" rel="stylesheet" type="text/css" />
    <!-- <link href="css/umc.css" rel="stylesheet" type="text/css" /> -->
    <link href="/rs/css/mobile.css?v.17" rel="stylesheet" type="text/css" />
    <script src="/rs/js/umc.js?v0.2" type="text/javascript"></script>
    <script>
        WDK.UI.Config({
            "posurl": '/EXP/' + (WDK.cookie('device') || WDK.cookie('device', WDK.uuid()))
        });
        WDK.UI.Config({
            "posurl": "http://192.168.210.160:8010/UMC/" + (WDK.cookie('device') || WDK.cookie('device', WDK.uuid()))
        });
        WDK.Src = '/';
    </script>
    <script src="/rs/js/umc.date.js"></script>
    <script src="/rs/js/umc.database.js"></script>
    <script src="/rs/js/umc.grid.js"></script>
    <script src="/rs/js/umc.dialog.js"></script>
    <script src="/rs/js/umc.ui.js?v0.12"></script>
    <script src="/rs/js/umc.page.js"></script>

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.7.13/dingtalk.open.js"></script>
    <style>
        .weui_tab_bd .wdk-section-header+.weui_cells {
            margin-top: 0px;
        }
        
        .weui_cell {
            padding: 15px;
        }
        
        .wdk_cell_icon::before {
            font-size: 18px;
        }
        
        .weui_tabbar_icon {
            margin: 0 auto;
            width: 34px;
            height: 34px;
        }
        
        div[ui=main] .weui_tabbar_icon::before {
            font-size: 24px;
        }
        
        .wdk-icon img {
            width: 40px;
            height: 40px;
            border-radius: 0px;
        }
        
        .wdk-icon ul {
            padding: 12px 0;
        }
        
        a.weui_cell[href]:after,
        .weui_cell[click-data]:after {
            display: none;
        }
    </style>

    <script>
        WDK.UI.Bridge = function(v, fn) {
            var xhr = new XMLHttpRequest();
            xhr.onload = function() {
                fn(JSON.parse(xhr.responseText));
            }
            var srcs = [WDK.UI.Config().posurl, '?', v.replace(/^&+/, '')];
            xhr.open("POST", srcs.join(''));
            xhr.send('');

        }
        dd.ready(function() {
            var corps = ['dingbc52122d6249fde335c2f4657eb6378f', 'ding62627792c7d958b935c2f4657eb6378f'];

            function permission(i) {
                var index = i || 0;
                if (index < corps.length) {
                    var corpId = corps[index];
                    dd.runtime.permission.requestAuthCode({
                        corpId: corpId,
                        onFail: function(err) {
                            if (err.errorCode == 3) {
                                permission(index + 1);
                            } else {
                                alert(JSON.stringify(err));
                            }
                        },
                        onSuccess: function(info) {
                            WDK.UI.Command('Exp', 'Login', {
                                'Code': info.code,
                                CorpId: corpId
                            });

                        }
                    });
                }
            }
            permission(0);

        });
    </script>
    <script>
        ($ => {

            $.UI.On('UI.Push', function(e, xhr) {

                var app = $(document.body);
                app.children('div[ui].ui').cls('ui', false).remove().on('backstage');
                app.append(xhr.root.cls('ui', true).on('active'));
            }).Off('Prompt').On("Prompt", function(e, p) {
                alert(p.Text);
            });

            WDK.page('main', '主页', false, function(root, title, menu) {

                var tabData = [{
                    "text": "收藏",
                    cmd: 'Favorite',
                    //     RefreshEvent: 'Favorite',
                    model: 'Exp',
                    "icon": "\uf1b3"
                }, {
                    "text": "数据分析",
                    cmd: 'Menu',
                    model: 'Exp',
                    "icon": "\uf200"
                }];
                var tabs = [];
                root.ui('Key.Report', function(e, item) {
                    location.hash = 'Exp?key=' + item.Key;
                    // console.log(arguments);
                }).ui('Favorite', function() {
                    tabs[0].query();
                }, true);

                var weui_tab = $('.weui_tab_bd', root);
                var tabbar = $('.weui_tabbar', root)
                    .on('click', 'a.weui_tabbar_item', function(e, auto) {
                        var me = $(this);
                        var index = parseInt(me.attr('data-index')) || 0;

                        if (!me.is('.weui_bar_item_on')) {

                            me.addClass('weui_bar_item_on').siblings('a').removeClass('weui_bar_item_on');

                            var body = weui_tab.children('div').eq(index);
                            body.css('display', 'flex').siblings('div').hide();
                            var data = tabData[index];
                            if (!body.attr('data-init')) {
                                body.attr('data-init', "Y");
                                body.html('<section style="flex: 1; overflow: auto"></section>')

                                var pager = new WDK.UI.Pager(body);
                                tabs.push(pager);
                                pager.model = data.model;
                                pager.cmd = data.cmd;
                                pager.search = data.search || {};
                                pager.query();
                            }

                        }
                        return false;
                    });
                tabbar.format(tabData, true)
                weui_tab.format(tabData, true);
                tabbar.find('a').each(function(i) {
                    var d = tabData[i];
                    var m = $(this).attr('data-index', i + '');

                    if (d.max) {
                        m.addClass('wdk-max-bar')
                    }
                }).eq(0).click(true);
            }).page('Exp', 'Exp', function(root) {
                // dd.biz.navigation.setRight({
                //     show: true,
                //     control: true,
                //     text: '收藏',
                //     onSuccess: function(result) {
                //         if (WDK(document.body).children('div[ui=Exp]').is('.ui')) {
                //             WDK.UI.Command('Exp', 'Favorite', {
                //                 Url: location.hash
                //             });
                //         }
                //     }
                // });
                root.on('active', function() {
                    dd.biz.navigation.setRight({
                        show: true,
                        control: true,
                        text: '收藏',
                        onSuccess: function(result) {
                            if (WDK(document.body).children('div[ui=Exp]').is('.ui')) {
                                WDK.UI.Command('Exp', 'Favorite', {
                                    Url: location.hash
                                });
                            }
                        }
                    });
                })
                root.on('hash', function(e, v) {
                    dd.biz.navigation.setRight({
                        show: true,
                        control: true,
                        text: '收藏',
                        onSuccess: function(result) {
                            if (WDK(document.body).children('div[ui=Exp]').is('.ui')) {
                                WDK.UI.Command('Exp', 'Favorite', {
                                    Url: location.hash
                                });
                            }
                        }
                    });
                    $('iframe', root).attr('src', [WDK.UI.Config().posurl, '/Exp/Report/', v.key].join(''))
                });
            });
            WDK.UI.On("Check.Pass", function() {
                location.reload();
            });
            WDK.UI.On("User", function() {
                $(window).on('popstate');
            });
        })(WDK);
    </script>
</head>

<body>
    <div ui="Exp">
        <iframe frameborder="0" style="width: 100vw; height: 100vh;"></iframe>
    </div>
    <div ui="main">
        <div class="weui_tab">
            <div class="weui_tab_bd">
                <script type="text/html">
                    <div class="wdk-tab-body-item">
                    </div>
                </script>
            </div>
            <footer class="weui_tabbar">
                <script type="text/html">
                    <a href="javascript:;" data-key="{key}" class="weui_tabbar_item">
                        <div class="weui_tabbar_icon" data-icon="{icon}"></div>
                        <p class="weui_tabbar_label">{text}</p>
                    </a>
                </script>
            </footer>
        </div>
    </div>
</body>

</html>